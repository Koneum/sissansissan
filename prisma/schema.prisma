// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
//output   = "../app/generated/prisma"

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODELS
// ============================================

model User {
  id            String         @id @default(cuid())
  name          String
  email         String         @unique
  emailVerified Boolean        @default(false)
  image         String?
  password      String?        // Not used by Better Auth (uses Account.password)
  phone         String?
  pushToken     String?        // Expo push notification token
  role          UserRole       @default(CUSTOMER)
  resetToken    String?        // Token pour réinitialisation mot de passe
  resetTokenExpiry DateTime?   // Expiration du token
  
  // Relations
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  wishlistItems WishlistItem[]
  cartItems     CartItem[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  sessions Session[]
  accounts Account[]
  permissions UserPermission[]

  @@index([email])
  @@index([createdAt])
  @@map("user")
}

enum UserRole {
  CUSTOMER
  PERSONNEL
  MANAGER
  ADMIN
  SUPER_ADMIN
}

// Permission system for granular access control
model Permission {
  id          String   @id @default(cuid())
  name        String   @unique  // e.g., "products.view", "orders.edit"
  description String?
  category    String   // e.g., "products", "orders", "customers"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userPermissions UserPermission[]

  @@map("permission")
}

model UserPermission {
  id           String   @id @default(cuid())
  userId       String
  permissionId String
  canView      Boolean  @default(true)
  canCreate    Boolean  @default(false)
  canEdit      Boolean  @default(false)
  canDelete    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("user_permission")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName String
  lastName  String
  address   String
  city      String
  state     String?
  country   String
  district  String   @map("zipCode")
  phone     String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// CATEGORY MODELS
// ============================================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?    @db.Text
  image       String?
  // Hierarchical structure
  parentId    String?
  parent      Category?  @relation("SubCategories", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("SubCategories")
  // Relations
  products    Product[]
  images      Image[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([parentId])
}

// ============================================
// IMAGE MODELS
// ============================================

model Image {
  id          String   @id @default(cuid())
  filename    String
  mimeType    String
  size        Int
  data        Bytes    @db.ByteA // Stockage binaire de l'image
  // Relations
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  reviewId    String?
  review      Review?  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([reviewId])
  @@index([categoryId])
}

// ============================================
// PRODUCT MODELS
// ============================================

model Product {
  id             String           @id @default(cuid())
  name           String
  slug           String           @unique
  description    String?          @db.Text
  shortDesc      String?          @db.Text
  // Pricing
  price          Float
  discountPrice  Float?
  salePercentage Int?
  // Inventory
  sku            String?          @unique
  stock          Int              @default(0)
  // Category
  categoryId     String
  category       Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  // Media
  images         String[] // Array of image URLs
  thumbnail      String? // Main image
  // Flags
  isNew          Boolean          @default(false)
  isFeatured     Boolean          @default(false)
  isActive       Boolean          @default(true)
  // Metadata
  tags           String[]
  attributes     Json? // Custom attributes { color: "red", size: "L" }
  // Relations
  productImages  Image[]
  variants       ProductVariant[]
  reviews        Review[]
  orderItems     OrderItem[]
  cartItems      CartItem[]
  wishlistItems  WishlistItem[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([isNew])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String // ex: "Color: Red, Size: L"
  sku       String?  @unique
  price     Float? // Override product price if set
  stock     Int      @default(0)
  image     String? // Variant-specific image
  options   Json // { color: "Red", size: "L" }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

// ============================================
// REVIEW MODELS
// ============================================

model Review {
  id           String       @id @default(cuid())
  userId       String
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId    String
  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  rating       Int // 1-5
  comment      String       @db.Text
  images       String[] // Review images (legacy)
  reviewImages Image[]
  status       ReviewStatus @default(PENDING)
  isVerified   Boolean      @default(false) // Verified purchase
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([productId])
  @@index([userId])
  @@index([status])
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// ORDER MODELS
// ============================================

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  // Order items
  items           OrderItem[]
  // Pricing
  subtotal        Float
  tax             Float?
  shipping        Float?
  discount        Float?
  total           Float
  // Coupon
  couponCode      String?
  couponId        String?
  coupon          Coupon?       @relation(fields: [couponId], references: [id], onDelete: SetNull)
  // Status
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  // Payment
  paymentMethod   String?
  paymentId       String? // Stripe payment intent ID
  // Addresses (stored as JSON for historical record)
  shippingAddress Json
  billingAddress  Json?
  // Shipping
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  // Notes
  customerNotes   String?       @db.Text
  adminNotes      String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity        Int
  price           Float // Price at time of purchase
  variantId       String?
  // Snapshot of product details at time of purchase
  productSnapshot Json?
  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}
//DEV BY MOUSSA KONE ET ABOUBAKAR SIDIBE (KRIS BEAT)
// ============================================
// CART MODELS
// ============================================

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  variantId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([productId])
}

// ============================================
// WISHLIST MODELS
// ============================================

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

// ============================================
// COUPON MODELS
// ============================================

model Coupon {
  id                   String       @id @default(cuid())
  code                 String       @unique
  discountType         DiscountType
  discountValue        Float
  // Conditions
  minPurchase          Float?
  maxDiscount          Float?
  // Usage limits
  usageLimit           Int?
  usedCount            Int          @default(0)
  perUserLimit         Int?
  // Validity
  validFrom            DateTime?
  validUntil           DateTime?
  status               CouponStatus @default(ACTIVE)
  // Applicability
  applicableProducts   String[] // Product IDs
  applicableCategories String[] // Category IDs
  // Relations
  orders               Order[]
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([code])
  @@index([status])
}

enum DiscountType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}

enum CouponStatus {
  ACTIVE
  DISABLED
  EXPIRED
}

// ============================================
// SETTINGS MODELS
// ============================================

model SiteSettings {
  id        String   @id @default(cuid())
  key       String   @unique // "footer", "header", "seo", etc.
  value     Json // Stores configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// ============================================
// PROMO BANNERS
// ============================================

model PromoBanner {
  id          String   @id @default(cuid())
  title       String
  subtitle    String?
  description String?
  discount    String?
  image       String
  buttonText  String   @default("Shop Now")
  buttonLink  String   @default("/shop")
  enabled     Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled, order])
  @@map("promo_banner")
}

// ============================================
// CONTACT MESSAGES
// ============================================

model ContactMessage {
  id        String               @id @default(cuid())
  firstName String
  lastName  String?
  email     String
  phone     String?
  subject   String               @default("Contact général")
  message   String
  status    ContactMessageStatus @default(NEW)
  notes     String?              // Admin notes
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("contact_message")
}

enum ContactMessageStatus {
  NEW
  READ
  REPLIED
  ARCHIVED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType @default(SYSTEM)
  isRead    Boolean          @default(false)
  data      Json?            // Extra data like orderId, productId, etc.
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notification")
}

enum NotificationType {
  ORDER      // Commande
  PROMO      // Promotion
  SYSTEM     // Système
  DELIVERY   // Livraison
  PRICE_DROP // Baisse de prix
  BACK_STOCK // Retour en stock
}

// ============================================
// AUDIT LOGS - Traçabilité des actions
// ============================================

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?     // Utilisateur qui a effectué l'action (null si système)
  userName    String?     // Nom de l'utilisateur pour référence rapide
  userEmail   String?     // Email pour référence
  action      AuditAction // Type d'action
  resource    String      // Ressource affectée (product, order, user, etc.)
  resourceId  String?     // ID de la ressource
  details     Json?       // Détails supplémentaires (avant/après, etc.)
  ipAddress   String?     // Adresse IP
  userAgent   String?     // User Agent du navigateur
  success     Boolean     @default(true)
  errorMessage String?    // Message d'erreur si échec
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_log")
}

enum AuditAction {
  // Authentification
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_RESET
  PASSWORD_CHANGE
  
  // CRUD générique
  CREATE
  READ
  UPDATE
  DELETE
  
  // Actions spécifiques
  ROLE_CHANGE
  PERMISSION_CHANGE
  ORDER_STATUS_CHANGE
  BULK_DELETE
  EXPORT_DATA
  IMPORT_DATA
  SETTINGS_CHANGE
}
